{% extends "base.html" %}
{% block title %}Resultados del An√°lisis{% endblock %}

{% block content %}

<!-- Librer√≠as necesarias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<div class="row">
    <div class="col-12">

        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="fas fa-chart-line me-2"></i>Resultados del An√°lisis
                </h2>

                <p class="text-muted mb-0">Archivo: {{ filename }}</p>

                {% if empresa.nombre %}
                    <p class="text-muted">Empresa: {{ empresa.nombre }}</p>
                {% endif %}
            </div>

            <div>
                <button id="downloadPdfBtn" class="btn btn-success me-2">
                    <i class="fas fa-file-pdf me-1"></i>Descargar Reporte PDF
                </button>

                <a href="{{ url_for('upload_page') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>Nuevo An√°lisis
                </a>
            </div>
        </div>

        <!-- Pesta√±as -->
        <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#resumen">
                    <i class="fas fa-home me-1"></i>Resumen
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#horizontal">
                    <i class="fas fa-arrows-alt-h me-1"></i>An√°lisis Horizontal
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vertical">
                    <i class="fas fa-arrows-alt-v me-1"></i>An√°lisis Vertical
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#razones">
                    <i class="fas fa-calculator me-1"></i>Razones Financieras
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#equilibrio">
                    <i class="fas fa-balance-scale me-1"></i>Punto de Equilibrio
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#predicciones">
                    <i class="fas fa-robot me-1"></i>Predicciones e IA
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#anomalias">
                    <i class="fas fa-bug me-1"></i>Anomal√≠as Financieras
                </button>
            </li>

            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#insights">
                    <i class="fas fa-lightbulb me-1"></i>Insights Autom√°ticos
                </button>
            </li>
        </ul>

        <!-- Contenido de pesta√±as -->
        <div class="tab-content">

            <div class="tab-pane fade show active" id="resumen">
                {% include "partials/_resumen_tab.html" %}
            </div>

            <div class="tab-pane fade" id="horizontal">
                {% include "partials/_horizontal_tab.html" %}
            </div>

            <div class="tab-pane fade" id="vertical">
                {% include "partials/_vertical_tab.html" %}
            </div>

            <div class="tab-pane fade" id="razones">
                {% include "partials/_razones_tab.html" %}
            </div>

            <div class="tab-pane fade" id="equilibrio">
                {% include "partials/_equilibrio_tab.html" %}
            </div>

            <div class="tab-pane fade" id="predicciones">
                {% include "partials/_predicciones_tab.html" %}
            </div>

            <div class="tab-pane fade" id="anomalias">
                {% include "partials/_anomalias_tab.html" %}
            </div>

            <div class="tab-pane fade" id="insights">
                {% include "partials/_insights_tab.html" %}
            </div>

        </div>
    </div>
</div>


<!-- --- DATOS PARA JAVASCRIPT (compatible con VSCode y Flask) --- -->
<!-- eslint-disable -->
<!-- jshint ignore:start -->

<script>
window.financialData = {
    resultados: {{ resultados.get("resultados", {}) | tojson | safe }},
    empresa: {{ empresa | default({}) | tojson | safe }},
    filename: "{{ filename or '' }}",
    graficos: {{ resultados.get("graficos", {}) | tojson | safe }}
};

console.log("üìä DATOS CARGADOS:", window.financialData);
</script>

<!-- jshint ignore:end -->


<!-- --- L√≥gica PDF --- -->
<script>
async function downloadPDF() {
    const btn = document.getElementById("downloadPdfBtn");
    const original = btn.innerHTML;

    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';

        const response = await fetch("/generar_pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filename: "{{ filename }}" })
        });

        if (!response.ok)
            throw new Error(await response.text());

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "reporte_financiero_{{ filename }}.pdf";
        a.click();

        URL.revokeObjectURL(url);

    } catch (err) {
        console.error("‚ùå Error al generar PDF:", err);
        alert("Error al generar PDF: " + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = original;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("downloadPdfBtn")
        .addEventListener("click", downloadPDF);
});
</script>

{% endblock %}
