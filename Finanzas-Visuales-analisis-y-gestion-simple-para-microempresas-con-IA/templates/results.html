{% extends "base.html" %}
{# jshint ignore:start #}
{% block title %}Resultados del An√°lisis{% endblock %}
<!-- Cargar Chart.js y nuestro charts.js -->

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="fas fa-chart-line me-2"></i>Resultados del An√°lisis
                </h2>
                <p class="text-muted mb-0">Archivo: {{ filename }}</p>
                {% if empresa.nombre %}
                <p class="text-muted">Empresa: {{ empresa.nombre }}</p>
                {% endif %}
            </div>
            <div>
                <button id="downloadPdfBtn" class="btn btn-success me-2">
                    <i class="fas fa-file-pdf me-1"></i>Descargar Reporte PDF
                </button>
                <a href="{{ url_for('upload_page') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>Nuevo An√°lisis
                </a>
            </div>
        </div>

        <!-- Pesta√±as de Navegaci√≥n -->
        <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" 
                        data-bs-target="#resumen" type="button" role="tab">
                    <i class="fas fa-home me-1"></i>Resumen
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="horizontal-tab" data-bs-toggle="tab" 
                        data-bs-target="#horizontal" type="button" role="tab">
                    <i class="fas fa-arrows-alt-h me-1"></i>An√°lisis Horizontal
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vertical-tab" data-bs-toggle="tab" 
                        data-bs-target="#vertical" type="button" role="tab">
                    <i class="fas fa-arrows-alt-v me-1"></i>An√°lisis Vertical
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="razones-tab" data-bs-toggle="tab" 
                        data-bs-target="#razones" type="button" role="tab">
                    <i class="fas fa-calculator me-1"></i>Razones Financieras
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="equilibrio-tab" data-bs-toggle="tab" 
                        data-bs-target="#equilibrio" type="button" role="tab">
                    <i class="fas fa-balance-scale me-1"></i>Punto de Equilibrio
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="predicciones-tab" data-bs-toggle="tab" 
                        data-bs-target="#predicciones" type="button" role="tab">
                    <i class="fas fa-robot me-1"></i>Predicciones e IA
                </button>
            </li>
        </ul>

        <!-- Contenido de Pesta√±as -->
        <div class="tab-content" id="analysisTabsContent">
            
            <!-- Pesta√±a 1: Resumen -->
            <div class="tab-pane fade show active" id="resumen" role="tabpanel">
                {% include 'partials/_resumen_tab.html' %}
            </div>

            <!-- Pesta√±a 2: An√°lisis Horizontal -->
            <div class="tab-pane fade" id="horizontal" role="tabpanel">
                {% include 'partials/_horizontal_tab.html' %}
            </div>

            <!-- Pesta√±a 3: An√°lisis Vertical -->
            <div class="tab-pane fade" id="vertical" role="tabpanel">
                {% include 'partials/_vertical_tab.html' %}
            </div>

            <!-- Pesta√±a 4: Razones Financieras -->
            <div class="tab-pane fade" id="razones" role="tabpanel">
                {% include 'partials/_razones_tab.html' %}
            </div>

            <!-- Pesta√±a 5: Punto de Equilibrio -->
            <div class="tab-pane fade" id="equilibrio" role="tabpanel">
                {% include 'partials/_equilibrio_tab.html' %}
            </div>
            <!-- Pesta√±a 6: Predicciones e IA -->
            <div class="tab-pane fade" id="predicciones" role="tabpanel">
                {% include 'partials/_predicciones_tab.html' %}
            </div>

        </div>
    </div>
</div>

<script>
    // VERSI√ìN MEJORADA - Incluye datos para gr√°ficos
    window.financialData = {
        resultados: {{ resultados.resultados | tojson | safe }},
        empresa: {{ empresa | tojson | safe }},
        filename: "{{ filename }}",
        graficos: {{ resultados.graficos | tojson | safe }}
    };
    
    console.log('üìä DATOS REALES CARGADOS:', window.financialData);
</script>
<script>
// Funci√≥n para descargar PDF
async function downloadPDF() {
    console.log('üéØ DEBUG: downloadPDF() ejecut√°ndose!');
    
    const btn = document.getElementById('downloadPdfBtn');
    const originalText = btn.innerHTML;
    
    try {
        // Mostrar estado de carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando PDF...';
        btn.disabled = true;
        
        console.log('üì§ DEBUG: Enviando request...');
        
        // Llamar al backend para generar PDF
        const response = await fetch('/generar_pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filename: "{{ filename }}"
            })
        });
        
        console.log('üì• DEBUG: Response recibida:', response.status);
        
        if (response.ok) {
            // Descargar el PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_financiero_{{ filename }}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ DEBUG: PDF descargado!');
            mostrarMensaje('‚úÖ PDF generado y descargado exitosamente', 'success');
        } else {
            const error = await response.text();
            throw new Error(error);
        }
        
    } catch (error) {
        console.error('‚ùå DEBUG: Error:', error);
        mostrarMensaje('‚ùå Error al generar el PDF: ' + error.message, 'danger');
    } finally {
        // Restaurar bot√≥n
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Funci√≥n para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
    alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alerta, container.firstChild);
    
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 5000);
}

// ‚úÖ EVENT LISTENER MEJORADO - Se ejecuta cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ DEBUG: DOM cargado, buscando bot√≥n...');
    
    const pdfBtn = document.getElementById('downloadPdfBtn');
    console.log('üéØ DEBUG: Bot√≥n encontrado:', pdfBtn);
    
    if (pdfBtn) {
        pdfBtn.addEventListener('click', downloadPDF);
        console.log('‚úÖ DEBUG: Event listener agregado correctamente');
        
        // Tambi√©n hacer la funci√≥n global para probar manualmente
        window.testPDF = downloadPDF;
    } else {
        console.error('‚ùå DEBUG: No se encontr√≥ el bot√≥n con id downloadPdfBtn');
    }
});

// ‚úÖ Tambi√©n exponer la funci√≥n globalmente para probar manualmente
window.downloadPDF = downloadPDF;
console.log('üîß DEBUG: downloadPDF disponible globalmente');
</script>

{% endblock %}
